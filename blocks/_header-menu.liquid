{%- doc -%}
  Renders a header menu block.

  @param {string} [variant] - What version of the menu to render. Defaults to header menu.
  @param {string} [transparent] - Show a transparent menu
{%- enddoc -%}

{% liquid
  assign block_settings = block.settings
  assign animation_speed = 200
  assign unique_id = 'HeaderMenu-' | append: block.id
%}

<div id="{{ unique_id }}" class="custom-header-menu-wrapper">
  {% if block.settings.enable_hover_effect %}
    <style>
      /* Scoping variables to this specific block only */
      #{{ unique_id }} {
        --hover-scale: {{ block.settings.hover_scale }};
        --hover-transition-duration: {{ block.settings.hover_transition_duration }}ms;
        {% if block.settings.hover_color != 'rgba(0,0,0,0)' %}
        --hover-color: {{ block.settings.hover_color }};
        {% endif %}
        {% if block.settings.underline_color != 'rgba(0,0,0,0)' %}
        --underline-color: {{ block.settings.underline_color }};
        {% endif %}
        --underline-thickness: {{ block.settings.underline_thickness }}px;
        --underline-offset: {{ block.settings.underline_offset }}px;
        --menu-top-level-font-size: {{ block.settings.type_font_primary_size }};
      }

      /* Underline effect - Scoped */
      {% if block.settings.hover_underline %}
      #{{ unique_id }} .menu-list__link {
        position: relative;
        overflow: visible; /* Changed from hidden to avoid clipping issues */
      }

      #{{ unique_id }} .menu-list__link::after {
        content: '';
        position: absolute;
        bottom: var(--underline-offset, 4px);
        left: 0;
        width: 100%;
        height: var(--underline-thickness, 2px);
        background-color: var(--underline-color, currentColor);
        {% if block.settings.underline_style == 'center' %}
        transform: scaleX(0);
        transform-origin: center;
        {% else %}
        transform: translateX(-100%);
        {% endif %}
        transition: transform var(--hover-transition-duration, 350ms) cubic-bezier(0.4, 0, 0.2, 1);
        opacity: 0.8;
        pointer-events: none;
      }

      #{{ unique_id }} .menu-list__list-item:hover .menu-list__link::after,
      #{{ unique_id }} .menu-list__list-item:focus-within .menu-list__link::after,
      #{{ unique_id }} .menu-list__list-item.menu-list__link--active .menu-list__link::after {
        {% if block.settings.underline_style == 'center' %}
        transform: scaleX(1);
        {% else %}
        transform: translateX(0);
        {% endif %}
      }
      {% endif %}

      /* Additional Effects - Scoped */
      {% if block.settings.enable_glow_effect %}
      #{{ unique_id }} .menu-list__list-item:hover .menu-list__link,
      #{{ unique_id }} .menu-list__list-item:focus-within .menu-list__link {
        text-shadow: 0 0 8px rgba(var(--color-foreground-rgb), 0.3);
      }
      {% endif %}

      {% if block.settings.enable_border_effect %}
      #{{ unique_id }} .menu-list__list-item:hover .menu-list__link,
      #{{ unique_id }} .menu-list__list-item:focus-within .menu-list__link {
        border: 1px solid rgba(var(--color-foreground-rgb), 0.1);
        border-radius: 4px;
      }
      {% endif %}

      /* Hover effects - Scoped */
      #{{ unique_id }} .menu-list__list-item {
        transition: transform var(--hover-transition-duration, 350ms) cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
        will-change: transform;
        opacity: 0.95;
      }

      #{{ unique_id }} .menu-list__list-item:hover,
      #{{ unique_id }} .menu-list__list-item:focus-within,
      #{{ unique_id }} .menu-list__list-item.menu-list__link--active {
        transform: scale(var(--hover-scale, 1.1));
        z-index: 10; /* Increased z-index to avoid overlapping issues */
        opacity: 1;
      }

      {% if block.settings.hover_color != 'rgba(0,0,0,0)' %}
      #{{ unique_id }} .menu-list__list-item:hover .menu-list__link,
      #{{ unique_id }} .menu-list__list-item:focus-within .menu-list__link,
      #{{ unique_id }} .menu-list__list-item.menu-list__link--active .menu-list__link {
        color: var(--hover-color);
      }
      {% endif %}
    </style>
  {% endif %}

  {% case variant %}
    {% when 'mobile' %}
      <div
        class="header__drawer desktop:hidden"
        ref="headerDrawerContainer"
        {{ block.shopify_attributes }}
      >
        {% render 'header-drawer',
          class: 'header__drawer--mobile',
          linklist: block_settings.menu,
          data_header_drawer_type: 'mobile-drawer'
        %}
      </div>

    {% when 'navigation_bar' %}
      {% if block_settings.navigation_bar == true %}
        <div
          class="menu-list menu-list--mobile{% if transparent == blank %} color-{{ block_settings.color_scheme_navigation_bar }}{% endif %}"
          style="--menu-horizontal-gap: 15px; --mobile-nav-margin: auto;"
        >
          <div class="menu-list__scroll-container">
            <ul
              class="menu-list__list list-unstyled"
              role="list"
            >
              {% for link in block_settings.menu.links %}
                <li>
                  <a
                    href="{{ link.url }}"
                    id="MenuItem-{{ link.handle }}"
                    class="menu-list__item"
                    {% if link.current %}
                      aria-current="page"
                    {% endif %}
                  >
                    {{- link.title -}}
                  </a>
                </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      {% endif %}
    {% else %}
      <header-menu
        ref="headerMenu"
        class="header-menu mobile:hidden"
        data-animation-delay="{{ animation_speed }}"
        {{ block.shopify_attributes }}
        style="--submenu-animation-speed: {{ animation_speed }}ms;"
      >
        <div class="header-menu__inner">
          {%- render 'header-menu' %}
        </div>

        <script
          src="{{ 'header-menu.js' | asset_url }}"
          type="module"
          fetchpriority="low"
        ></script>
      </header-menu>
  {% endcase %}
</div>

{% style %}
  /* MOVING CRITICAL CSS HERE AND SCOPING IT
    to prevent global pollution
  */

  #{{ unique_id }} .menu-list {
    --menu-horizontal-gap: var(--gap-xl, 2rem);
    --menu-vertical-gap: var(--gap-xl, 2rem);

    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    gap: var(--menu-horizontal-gap);
    margin: 0;
    padding: 0;
  }

  #{{ unique_id }} .menu-list__list {
    display: flex;
    justify-content: var(--grid-area-alignment, center);
    flex-wrap: wrap;
    gap: var(--menu-horizontal-gap);
    list-style: none;
    margin: 0;
    padding: 0;
  }

  #{{ unique_id }} .menu-list__list-item {
    flex-shrink: 0;
    white-space: nowrap;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 44px; /* Explicit value instead of variable */
    padding: 0.25rem 0.5rem;
    margin: 0 0.125rem;
  }

  #{{ unique_id }} .menu-list__link {
    font-size: var(--menu-top-level-font-size, 1rem);
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem 1rem;
    position: relative;
    z-index: 1;
    color: currentColor; /* Inherit color safely */
    line-height: 1.3;
  }

  /* Fix Mobile styles specific to this block */
  #{{ unique_id }} .menu-list--mobile {
    display: grid;
    width: 100%;
  }

  #{{ unique_id }} .menu-list--mobile .menu-list__list {
    width: max-content;
    margin-inline: auto;
    display: flex;
    flex-direction: row; /* Force row */
  }

  #{{ unique_id }} .menu-list__scroll-container {
     width: 100%;
     overflow-x: auto;
     -webkit-overflow-scrolling: touch;
     scrollbar-width: none; /* Firefox */
  }

  #{{ unique_id }} .menu-list__scroll-container::-webkit-scrollbar {
    display: none; /* Chrome/Safari */
  }

  /* Prevent overlapping on desktop */
  @media screen and (min-width: 990px) {
    #{{ unique_id }} .mobile\:hidden {
      display: block !important;
    }
    #{{ unique_id }} .desktop\:hidden {
      display: none !important;
    }
  }

  /* Prevent overlapping on mobile */
  @media screen and (max-width: 989px) {
    #{{ unique_id }} .mobile\:hidden {
      display: none !important;
    }
    #{{ unique_id }} .desktop\:hidden {
      display: block !important;
    }
  }

  /* Fix for the absolute positioning of Mega Menus */
  #{{ unique_id }} .menu-list__submenu {
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    min-width: 200px; /* Prevent skinny dropdowns */
    background: var(--gradient-background);
    z-index: 20;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }

  /* Specific fix for superposed text lines */
  #{{ unique_id }} .menu-list__item {
     display: inline-block;
  }
{% endstyle %}

{% schema %}
{
  "name": "t:names.menu",
  "tag": null,
  "settings": [
    {
      "type": "link_list",
      "id": "menu",
      "label": "t:settings.menu",
      "default": "main-menu"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:settings.color_scheme",
      "default": "primary"
    },
    {
      "type": "header",
      "content": "t:content.typography"
    },
    {
      "type": "select",
      "id": "type_font_primary_size",
      "label": "t:settings.top_level_size",
      "options": [
        {
          "value": "0.625rem",
          "label": "10px"
        },
        {
          "value": "0.75rem",
          "label": "12px"
        },
        {
          "value": "0.875rem",
          "label": "14px"
        },
        {
          "value": "1rem",
          "label": "16px"
        },
        {
          "value": "1.125rem",
          "label": "18px"
        }
      ],
      "default": "1rem"
    },
    {
      "type": "select",
      "id": "menu_font_style",
      "label": "t:settings.submenu_text_style",
      "options": [
        {
          "value": "regular",
          "label": "t:options.small"
        },
        {
          "value": "inverse",
          "label": "t:options.medium"
        },
        {
          "value": "inverse_large",
          "label": "t:options.large"
        }
      ],
      "default": "inverse"
    },
    {
      "type": "select",
      "id": "type_font_primary_link",
      "label": "t:settings.font",
      "options": [
        {
          "value": "body",
          "label": "t:options.body"
        },
        {
          "value": "subheading",
          "label": "t:options.subheading"
        },
        {
          "value": "heading",
          "label": "t:options.heading"
        },
        {
          "value": "accent",
          "label": "t:options.accent"
        }
      ],
      "default": "heading"
    },
    {
      "type": "select",
      "id": "type_case_primary_link",
      "label": "t:settings.text_case",
      "options": [
        {
          "value": "none",
          "label": "t:options.default"
        },
        {
          "value": "uppercase",
          "label": "t:options.uppercase"
        }
      ],
      "default": "none"
    },
    {
      "type": "header",
      "content": "Hover Effect"
    },
    {
      "type": "checkbox",
      "id": "enable_hover_effect",
      "label": "Enable Hover Effect",
      "default": true
    },
    {
      "type": "range",
      "id": "hover_scale",
      "label": "Hover Scale",
      "min": 1,
      "max": 1.5,
      "step": 0.1,
      "default": 1.1,
      "unit": "x"
    },
    {
      "type": "range",
      "id": "hover_transition_duration",
      "label": "Hover Transition Duration",
      "min": 100,
      "max": 1000,
      "step": 50,
      "default": 350,
      "unit": "ms"
    },
    {
      "type": "color",
      "id": "hover_color",
      "label": "Hover Text Color",
      "default": "rgba(0,0,0,0)"
    },
    {
      "type": "header",
      "content": "Underline Settings"
    },
    {
      "type": "checkbox",
      "id": "hover_underline",
      "label": "Show Underline on Hover",
      "default": true
    },
    {
      "type": "select",
      "id": "underline_style",
      "label": "Underline Animation Style",
      "options": [
        {
          "value": "left",
          "label": "Slide from left"
        },
        {
          "value": "center",
          "label": "Expand from center"
        }
      ],
      "default": "left"
    },
    {
      "type": "color",
      "id": "underline_color",
      "label": "Underline Color",
      "default": "rgba(0,0,0,0)"
    },
    {
      "type": "range",
      "id": "underline_thickness",
      "label": "Underline Thickness",
      "min": 1,
      "max": 6,
      "step": 0.5,
      "default": 2,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "underline_offset",
      "label": "Underline Offset",
      "min": 0,
      "max": 20,
      "step": 1,
      "default": 4,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Additional Effects"
    },
    {
      "type": "checkbox",
      "id": "enable_glow_effect",
      "label": "Enable Glow Effect",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "enable_border_effect",
      "label": "Enable Border Effect",
      "default": false
    },
    {
      "type": "header",
      "content": "t:content.submenu_feature"
    },
    {
      "type": "select",
      "id": "menu_style",
      "label": "t:settings.media_type",
      "info": "t:info.media_type_info",
      "options": [
        {
          "value": "text",
          "label": "t:options.none"
        },
        {
          "value": "collection_images",
          "label": "t:options.collection_images"
        },
        {
          "value": "featured_products",
          "label": "t:options.featured_products"
        },
        {
          "value": "featured_collections",
          "label": "t:options.featured_collections"
        }
      ],
      "default": "collection_images"
    },
    {
      "type": "select",
      "id": "featured_products_aspect_ratio",
      "label": "t:settings.image_ratio",
      "options": [
        {
          "value": "adapt",
          "label": "t:options.auto"
        },
        {
          "value": "4 / 5",
          "label": "t:options.portrait"
        },
        {
          "value": "1 / 1",
          "label": "t:options.square"
        }
      ],
      "default": "4 / 5"
    },
    {
      "type": "select",
      "id": "featured_collections_aspect_ratio",
      "label": "t:settings.image_ratio",
      "options": [
        {
          "value": "adapt",
          "label": "t:options.auto"
        },
        {
          "value": "16 / 9",
          "label": "t:options.landscape"
        },
        {
          "value": "1 / 1",
          "label": "t:options.square"
        }
      ],
      "default": "16 / 9"
    },
    {
      "type": "range",
      "id": "image_border_radius",
      "label": "t:settings.image_border_radius",
      "min": 0,
      "max": 32,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "header",
      "content": "t:content.mobile_layout"
    },
    {
      "type": "checkbox",
      "id": "navigation_bar",
      "label": "t:settings.navigation_bar",
      "default": false
    },
    {
      "type": "color_scheme",
      "id": "color_scheme_navigation_bar",
      "label": "t:settings.navigation_bar_color_scheme",
      "default": "primary"
    },
    {
      "type": "checkbox",
      "id": "drawer_accordion",
      "label": "t:settings.accordion",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "drawer_accordion_expand_first",
      "label": "t:settings.expand_first_group",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "drawer_dividers",
      "label": "t:settings.dividers",
      "default": false
    }
  ]
}
{% endschema %}
