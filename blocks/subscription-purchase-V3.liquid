{% doc %}
  Pronto-Chocho Multi-Product Selector v3
  Integración completa con Shopify Subscriptions App
  Compatible con temas modernos (cart-drawer-component) y legacy (reload)
{% enddoc %}
{% assign block_id = block.id | replace: '_', '' | downcase %}

{% style %}
  .chocho-selector-{{ block_id }} {
    width: 100%;
    max-width: 480px;
    margin: 0 auto;
    font-family: var(--font-body-family), -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  }

  .chocho-selector__purchase-options-{{ block_id }} {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 24px;
  }

  .chocho-selector__option-{{ block_id }} {
    position: relative;
    border: 2px solid {{ block.settings.border_color | default: '#E8E4DF' }};
    border-radius: 12px;
    padding: 20px 16px;
    cursor: pointer;
    transition: all 0.2s ease;
    background: {{ block.settings.option_bg | default: '#FFFCF8' }};
  }

  .chocho-selector__option-{{ block_id }}:hover {
    border-color: {{ block.settings.border_hover | default: '#4A6B1A' }};
  }

  .chocho-selector__option-{{ block_id }}.active {
    border-color: {{ block.settings.active_border | default: '#4A6B1A' }};
    background: {{ block.settings.active_bg | default: '#FCF3EC' }};
  }

  .chocho-selector__option-{{ block_id }}.active::before {
    content: 'Most Popular';
    position: absolute;
    top: -10px;
    left: 16px;
    background: {{ block.settings.badge_bg | default: '#4A6B1A' }};
    color: white;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    padding: 4px 12px;
    border-radius: 20px;
    letter-spacing: 0.5px;
  }

  .chocho-selector__option-inner-{{ block_id }} {
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }

  .chocho-selector__radio-{{ block_id }} {
    width: 20px;
    height: 20px;
    border: 2px solid {{ block.settings.radio_border | default: '#CCCCCC' }};
    border-radius: 50%;
    flex-shrink: 0;
    margin-top: 2px;
    position: relative;
    background: white;
    transition: all 0.2s;
  }

  .chocho-selector__option-{{ block_id }}.active .chocho-selector__radio-{{ block_id }} {
    border-color: {{ block.settings.active_radio | default: '#4A6B1A' }};
  }

  .chocho-selector__option-{{ block_id }}.active .chocho-selector__radio-{{ block_id }}::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 10px;
    height: 10px;
    background: {{ block.settings.active_radio | default: '#4A6B1A' }};
    border-radius: 50%;
  }

  .chocho-selector__option-content-{{ block_id }} { flex: 1; min-width: 0; }

  .chocho-selector__option-header-{{ block_id }} {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 4px;
  }

  .chocho-selector__option-title-{{ block_id }} {
    font-size: 16px;
    font-weight: 800;
    color: {{ block.settings.title_color | default: '#1a1a1a' }};
    margin: 0;
    line-height: 1.3;
  }

  .chocho-selector__option-subtitle-{{ block_id }} {
    font-size: 13px;
    color: {{ block.settings.subtitle_color | default: '#666666' }};
    margin: 2px 0 0;
  }

  .chocho-selector__option-price-{{ block_id }} { text-align: right; }

  .chocho-selector__price-main-{{ block_id }} {
    display: block;
    font-size: 18px;
    font-weight: 800;
    color: {{ block.settings.price_color | default: '#4A6B1A' }};
    line-height: 1.2;
  }

  .chocho-selector__price-main-{{ block_id }} s {
    color: {{ block.settings.compare_color | default: '#999999' }};
    font-weight: 400;
    font-size: 14px;
    margin-right: 6px;
    text-decoration: line-through;
  }

  .chocho-selector__price-per-{{ block_id }} {
    font-size: 12px;
    color: {{ block.settings.per_color | default: '#666666' }};
    font-weight: 400;
  }

  .chocho-selector__benefits-{{ block_id }} { margin: 12px 0 0; padding: 0; list-style: none; }

  .chocho-selector__benefits-{{ block_id }} li {
    position: relative;
    padding-left: 18px;
    font-size: 13px;
    color: {{ block.settings.benefit_color | default: '#555555' }};
    margin-bottom: 6px;
    line-height: 1.4;
  }

  .chocho-selector__benefits-{{ block_id }} li::before {
    content: '✓';
    position: absolute;
    left: 0;
    color: {{ block.settings.check_color | default: '#4A6B1A' }};
    font-weight: 700;
  }

  .chocho-selector__products-{{ block_id }} { margin-bottom: 20px; }

  .chocho-selector__products-label-{{ block_id }} {
    font-size: 14px;
    font-weight: 600;
    color: {{ block.settings.label_color | default: '#1a1a1a' }};
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .chocho-selector__product-list-{{ block_id }} { display: flex; flex-direction: column; gap: 10px; }

  .chocho-selector__product-{{ block_id }} {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: white;
    border: 1px solid {{ block.settings.product_border | default: '#E8E4DF' }};
    border-radius: 10px;
    transition: all 0.2s;
  }

  .chocho-selector__product-{{ block_id }}:hover {
    border-color: {{ block.settings.border_hover | default: '#4A6B1A' }};
  }

  .chocho-selector__product-image-{{ block_id }} {
    width: 56px;
    height: 56px;
    border-radius: 8px;
    overflow: hidden;
    flex-shrink: 0;
    background: {{ block.settings.image_bg | default: '#f5f5f5' }};
  }

  .chocho-selector__product-image-{{ block_id }} img { width: 100%; height: 100%; object-fit: cover; }

  .chocho-selector__product-info-{{ block_id }} { flex: 1; min-width: 0; }

  .chocho-selector__product-name-{{ block_id }} {
    font-size: 14px;
    font-weight: 600;
    color: {{ block.settings.product_name_color | default: '#1a1a1a' }};
    margin: 0 0 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .chocho-selector__product-servings-{{ block_id }} {
    font-size: 12px;
    color: {{ block.settings.servings_color | default: '#888888' }};
  }

  .chocho-selector__quantity-{{ block_id }} { display: flex; align-items: center; gap: 8px; }

  .chocho-selector__qty-btn-{{ block_id }} {
    width: 32px;
    height: 32px;
    border: 1px solid {{ block.settings.qty_border | default: '#DDDDDD' }};
    background: white;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 16px;
    color: {{ block.settings.qty_color | default: '#1a1a1a' }};
    transition: all 0.15s;
  }

  .chocho-selector__qty-btn-{{ block_id }}:hover:not(:disabled) {
    background: {{ block.settings.qty_hover_bg | default: '#f5f5f5' }};
    border-color: {{ block.settings.border_hover | default: '#4A6B1A' }};
  }

  .chocho-selector__qty-btn-{{ block_id }}:disabled { opacity: 0.3; cursor: not-allowed; }

  .chocho-selector__qty-display-{{ block_id }} {
    min-width: 28px;
    text-align: center;
    font-size: 15px;
    font-weight: 700;
    color: {{ block.settings.qty_color | default: '#1a1a1a' }};
  }

  .chocho-selector__savings-{{ block_id }} {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 16px;
    background: {{ block.settings.savings_bg | default: '#F5F5F5' }};
    border-radius: 10px;
    margin-bottom: 16px;
    font-size: 14px;
  }

  .chocho-selector__savings-text-{{ block_id }} { color: {{ block.settings.savings_text_color | default: '#666666' }}; }

  .chocho-selector__savings-amount-{{ block_id }} {
    color: {{ block.settings.savings_amount_color | default: '#4A6B1A' }};
    font-weight: 700;
  }

  .chocho-selector__savings-price-{{ block_id }} {
    font-weight: 700;
    color: {{ block.settings.title_color | default: '#1a1a1a' }};
  }

  .chocho-selector__savings-price-{{ block_id }} s {
    color: {{ block.settings.compare_color | default: '#999999' }};
    font-weight: 400;
    margin-right: 6px;
  }

  /* Plan badge — muestra si el plan fue cargado del plugin o del fallback manual */
  .chocho-selector__plan-badge-{{ block_id }} {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: {{ block.settings.savings_amount_color | default: '#4A6B1A' }};
    margin-bottom: 8px;
    font-weight: 600;
  }

  .chocho-selector__plan-badge-{{ block_id }}[data-source="manual"] {
    color: #888;
  }

  .chocho-selector__submit-{{ block_id }} {
    width: 100%;
    padding: 18px 24px;
    background: {{ block.settings.button_bg | default: '#1a1a1a' }};
    color: {{ block.settings.button_text_color | default: '#ffffff' }};
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
  }

  .chocho-selector__submit-{{ block_id }}:hover:not(:disabled) {
    background: {{ block.settings.button_hover | default: '#333333' }};
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  .chocho-selector__submit-{{ block_id }}:disabled { opacity: 0.5; cursor: not-allowed; }

  .chocho-selector__submit-{{ block_id }}.loading { color: transparent; }

  .chocho-selector__submit-{{ block_id }}.loading::after {
    content: '';
    position: absolute;
    width: 20px;
    height: 20px;
    top: 50%;
    left: 50%;
    margin: -10px 0 0 -10px;
    border: 2px solid white;
    border-radius: 50%;
    border-top-color: transparent;
    animation: chocho-spin-{{ block_id }} 0.8s linear infinite;
  }

  @keyframes chocho-spin-{{ block_id }} { to { transform: rotate(360deg); } }

  .chocho-notification-{{ block_id }} {
    position: fixed;
    top: 20px;
    right: 20px;
    background: {{ block.settings.notification_bg | default: '#4A6B1A' }};
    color: white;
    padding: 16px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 9999;
    transform: translateX(150%);
    transition: transform 0.3s ease;
    font-weight: 600;
    max-width: 300px;
    font-size: 14px;
    line-height: 1.4;
  }

  .chocho-notification-{{ block_id }}.show { transform: translateX(0); }

  .visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    border: 0;
  }

  @media (max-width: 749px) {
    .chocho-selector-{{ block_id }} { padding: 0 16px; }
    .chocho-selector__option-{{ block_id }} { padding: 16px 12px; }
    .chocho-selector__price-main-{{ block_id }} { font-size: 16px; }
  }
{% endstyle %}

{% comment %} ===== HTML ===== {% endcomment %}
<div class="chocho-selector-{{ block_id }}" data-chocho-selector="{{ block_id }}">
  <div class="chocho-selector__purchase-options-{{ block_id }}">
    {% comment %} Suscripción {% endcomment %}
    <div class="chocho-selector__option-{{ block_id }} active" data-option="subscription">
      <label class="chocho-selector__option-inner-{{ block_id }}">
        <input type="radio" name="purchase_type_{{ block_id }}" value="subscription" checked class="visually-hidden">
        <span class="chocho-selector__radio-{{ block_id }}"></span>
        <div class="chocho-selector__option-content-{{ block_id }}">
          <div class="chocho-selector__option-header-{{ block_id }}">
            <div>
              <h3 class="chocho-selector__option-title-{{ block_id }}">
                {{ block.settings.sub_title | default: 'Subscribe & Save' }}
              </h3>
              <p class="chocho-selector__option-subtitle-{{ block_id }}">
                {{ block.settings.sub_subtitle | default: '15 servings per bag' }}
              </p>
            </div>
            <div class="chocho-selector__option-price-{{ block_id }}">
              <span class="chocho-selector__price-main-{{ block_id }}">
                <s data-compare-price>—</s>
                <span data-subscription-price>—</span>
              </span>
              <span class="chocho-selector__price-per-{{ block_id }}">
                <span data-price-per>—</span> / {{ block.settings.per_text | default: 'serving' }}
              </span>
            </div>
          </div>
          {% if block.settings.show_benefits %}
            <ul class="chocho-selector__benefits-{{ block_id }}">
              {% for i in (1..4) %}
                {% assign benefit_key = 'benefit_' | append: i %}
                {% if block.settings[benefit_key] != blank %}
                  <li>{{ block.settings[benefit_key] }}</li>
                {% endif %}
              {% endfor %}
            </ul>
          {% endif %}
        </div>
      </label>
    </div>

    {% comment %} One-time {% endcomment %}
    <div class="chocho-selector__option-{{ block_id }}" data-option="onetime">
      <label class="chocho-selector__option-inner-{{ block_id }}">
        <input type="radio" name="purchase_type_{{ block_id }}" value="onetime" class="visually-hidden">
        <span class="chocho-selector__radio-{{ block_id }}"></span>
        <div class="chocho-selector__option-content-{{ block_id }}">
          <div class="chocho-selector__option-header-{{ block_id }}">
            <div>
              <h3 class="chocho-selector__option-title-{{ block_id }}">
                {{ block.settings.onetime_title | default: 'One-time purchase' }}
              </h3>
              <p class="chocho-selector__option-subtitle-{{ block_id }}">
                {{ block.settings.onetime_subtitle | default: '15 servings per bag' }}
              </p>
            </div>
            <div class="chocho-selector__option-price-{{ block_id }}">
              <span class="chocho-selector__price-main-{{ block_id }}" data-onetime-price>—</span>
              <span class="chocho-selector__price-per-{{ block_id }}">
                <span data-onetime-per>—</span> / {{ block.settings.per_text | default: 'serving' }}
              </span>
            </div>
          </div>
        </div>
      </label>
    </div>
  </div>

  {% comment %} ===== PRODUCTOS ===== {% endcomment %}
  {% assign has_products = false %}
  {% for i in (1..5) %}
    {% capture product_key %}product_{{ i }}{% endcapture %}
    {% if block.settings[product_key] != blank -%}
      {%- assign has_products = true -%}
      {%- break -%}
    {%- endif %}
  {% endfor %}

  {% if has_products %}
    <div class="chocho-selector__products-{{ block_id }}">
      <p class="chocho-selector__products-label-{{ block_id }}">
        {{ block.settings.flavors_label | default: 'Choose your flavors' }}
      </p>
      <div class="chocho-selector__product-list-{{ block_id }}">
        {% for i in (1..5) %}
          {% assign product_key = 'product_' | append: i %}
          {% assign product = block.settings[product_key] %}
          {% if product != blank %}
            {% assign variant = product.selected_or_first_available_variant %}
            <div
              class="chocho-selector__product-{{ block_id }}"
              data-product-id="{{ product.id }}"
              data-variant-id="{{ variant.id }}"
              data-price="{{ variant.price }}"
              data-compare="{{ variant.compare_at_price | default: variant.price }}"
            >
              <div class="chocho-selector__product-image-{{ block_id }}">
                {% if product.featured_image %}
                  <img
                    src="{{ product.featured_image | image_url: width: 120, height: 120, crop: 'center' }}"
                    alt="{{ product.title | escape }}"
                    loading="lazy"
                    width="56"
                    height="56"
                  >
                {% else %}
                  {{ 'product-1' | placeholder_svg_tag }}
                {% endif %}
              </div>
              <div class="chocho-selector__product-info-{{ block_id }}">
                <h4 class="chocho-selector__product-name-{{ block_id }}">{{ product.title }}</h4>
                <span class="chocho-selector__product-servings-{{ block_id }}">
                  {{- block.settings.servings_text | default: '15 servings' -}}
                </span>
              </div>
              <div class="chocho-selector__quantity-{{ block_id }}">
                <button
                  type="button"
                  class="chocho-selector__qty-btn-{{ block_id }}"
                  data-qty="minus"
                  aria-label="Decrease"
                >
                  −
                </button>
                <span class="chocho-selector__qty-display-{{ block_id }}" data-quantity>0</span>
                <button
                  type="button"
                  class="chocho-selector__qty-btn-{{ block_id }}"
                  data-qty="plus"
                  aria-label="Increase"
                >
                  +
                </button>
              </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>

    <div class="chocho-selector__savings-{{ block_id }}">
      <span class="chocho-selector__savings-text-{{ block_id }}">
        {{ block.settings.savings_label | default: "You're saving" }}
        <span class="chocho-selector__savings-amount-{{ block_id }}" data-savings>$0.00</span>
      </span>
      <span class="chocho-selector__savings-price-{{ block_id }}">
        <s data-total-compare>$0.00</s>
        <span data-total-price>$0.00</span>
      </span>
    </div>

    <button type="button" class="chocho-selector__submit-{{ block_id }}" data-add-to-cart disabled>
      {{ block.settings.button_text | default: 'Add to Cart' }}
    </button>

  {% else %}
    <p style="text-align:center;color:#666;padding:40px;">Selecciona productos en la configuración del bloque</p>
  {% endif %}
</div>

<div class="chocho-notification-{{ block_id }}" data-chocho-notification></div>

{%- comment -%}
  TAREA 1 – Input oculto con clase .selected-selling-plan-id
  Se inyecta DENTRO del bloque (scope propio). El script también lo escribe
  en el form del tema para que ShopifySubscriptionsWidget lo detecte.
{%- endcomment -%}
<input
  type="hidden"
  name="selling_plan"
  class="selected-selling-plan-id chocho-selling-plan-{{ block_id }}"
  value=""
  aria-hidden="true"
>

<script>
(function () {
  'use strict';

  /* ─────────────────────────────────────────────────────────────────────────
   * CONFIGURACIÓN
   * ───────────────────────────────────────────────────────────────────────── */
  const blockId        = '{{ block_id }}';
  const fallbackPlanId = (function () {
    const raw = '{{ block.settings.selling_plan_id | strip }}';
    const n   = parseInt(raw, 10);
    return Number.isFinite(n) && n > 0 ? n : null;
  })();
  const discountPercent  = {{ block.settings.subscription_discount | default: 15 }};
  const servingsPerUnit  = {{ block.settings.servings_per_unit | default: 15 }};

  /* ─────────────────────────────────────────────────────────────────────────
   * ELEMENTOS
   * ───────────────────────────────────────────────────────────────────────── */
  const container      = document.querySelector(`[data-chocho-selector="${blockId}"]`);
  if (!container) return;

  const options        = container.querySelectorAll('[data-option]');
  const products       = container.querySelectorAll('[data-product-id]');
  const savingsEl      = container.querySelector('[data-savings]');
  const totalCompareEl = container.querySelector('[data-total-compare]');
  const totalPriceEl   = container.querySelector('[data-total-price]');
  const subPriceEl     = container.querySelector('[data-subscription-price]');
  const comparePriceEl = container.querySelector('[data-compare-price]');
  const pricePerEl     = container.querySelector('[data-price-per]');
  const onetimePriceEl = container.querySelector('[data-onetime-price]');
  const onetimePerEl   = container.querySelector('[data-onetime-per]');
  const submitBtn      = container.querySelector('[data-add-to-cart]');
  const notification   = document.querySelector(`.chocho-notification-${blockId}`);

  // Input hidden de selling_plan (TAREA 1)
  const ownSellingPlanInput = document.querySelector(`.chocho-selling-plan-${blockId}`);

  /* ─────────────────────────────────────────────────────────────────────────
   * ESTADO
   * ───────────────────────────────────────────────────────────────────────── */
  let currentOption = 'subscription';
  let quantities    = {};
  let isProcessing  = false;

  products.forEach(p => { quantities[p.dataset.variantId] = 0; });

  /* ─────────────────────────────────────────────────────────────────────────
   * TAREA 2 – LEER PRECIOS DESDE EL PLUGIN (con fallback al cálculo manual)
   *
   * El plugin ShopifySubscriptionsWidget expone los precios reales del plan
   * en los radio buttons de suscripción:
   *   <input type="radio"
   *     data-selling-plan-id="3233841344"
   *     data-variant-price="4249"          ← precio con suscripción (centavos)
   *     data-variant-compare-at-price="4999" ← precio original (centavos)
   *   >
   *
   * Intentamos leer esos atributos antes de hacer cualquier cálculo.
   * ───────────────────────────────────────────────────────────────────────── */

  /**
   * Intenta leer el selling_plan_id y sus precios desde el plugin oficial.
   * Devuelve null si el plugin no está presente o no ha cargado aún.
   *
   * @returns {object|null} { planId: number, price: number, compareAtPrice: number } or null
   */
  function readPluginPlan() {
    // Buscar el radio button chequeado del plugin (puede estar en cualquier section del producto)
    const checkedRadio = document.querySelector(
      'input[type="radio"][data-selling-plan-id]:checked'
    );
    if (checkedRadio) return extractPlanData(checkedRadio);

    // Si ninguno está chequeado, tomar el primero disponible
    const firstRadio = document.querySelector(
      'input[type="radio"][data-selling-plan-id]'
    );
    if (firstRadio) return extractPlanData(firstRadio);

    return null;
  }

  function extractPlanData(radio) {
    const planId = parseInt(radio.dataset.sellingPlanId, 10);
    const price  = parseInt(radio.dataset.variantPrice, 10);
    const cmp    = parseInt(radio.dataset.variantCompareAtPrice, 10);

    if (!Number.isFinite(planId) || planId <= 0) return null;

    return {
      planId,
      price          : Number.isFinite(price) ? price : 0,
      compareAtPrice : Number.isFinite(cmp)   ? cmp   : price,
    };
  }

  /* ─────────────────────────────────────────────────────────────────────────
   * HELPERS DE FORMATO
   * ───────────────────────────────────────────────────────────────────────── */
  function formatMoney(cents) {
    return '$' + (cents / 100).toFixed(2);
  }

  /* ─────────────────────────────────────────────────────────────────────────
   * CÁLCULO DE PRECIOS
   * ───────────────────────────────────────────────────────────────────────── */
  function calculatePrices() {
    // Intentar leer el plan del plugin primero
    const pluginData   = readPluginPlan();
    const isSubscription = currentOption === 'subscription';

    // Precio unitario de referencia (primer producto, para el encabezado)
    const firstProduct = products[0];
    const baseOnetimePrice = firstProduct ? parseInt(firstProduct.dataset.price, 10) : 0;
    const baseComparePrice = firstProduct ? parseInt(firstProduct.dataset.compare, 10) : baseOnetimePrice;

    // Precio de suscripción por unidad: plugin tiene prioridad
    let subUnitPrice;
    if (isSubscription && pluginData && pluginData.price > 0) {
      subUnitPrice = pluginData.price;
    } else {
      subUnitPrice = Math.round(baseOnetimePrice * (1 - discountPercent / 100));
    }

    // Compare price de referencia para el encabezado
    const refComparePrice = (isSubscription && pluginData)
      ? pluginData.compareAtPrice
      : baseComparePrice;

    let totalQty        = 0;
    let totalRegular    = 0;
    let totalDiscounted = 0;

    products.forEach(p => {
      const qty     = quantities[p.dataset.variantId] || 0;
      const price   = parseInt(p.dataset.price,   10);
      const compare = parseInt(p.dataset.compare, 10);

      totalQty     += qty;
      totalRegular += compare * qty;

      if (isSubscription && pluginData && pluginData.price > 0) {
        // Escalar el precio del plugin proporcionalmente al precio de cada producto
        // Si todos los productos tienen el mismo precio, el ratio es 1.
        const ratio = baseOnetimePrice > 0 ? price / baseOnetimePrice : 1;
        totalDiscounted += Math.round(pluginData.price * ratio) * qty;
      } else if (isSubscription) {
        totalDiscounted += Math.round(price * (1 - discountPercent / 100)) * qty;
      } else {
        totalDiscounted += price * qty;
      }
    });

    return {
      subUnit          : subUnitPrice,
      onetimeUnit      : baseOnetimePrice,
      subPerServing    : subUnitPrice / servingsPerUnit,
      onetimePerServing: baseOnetimePrice / servingsPerUnit,
      refComparePrice,
      totalQty,
      totalRegular,
      totalDiscounted,
      savings          : totalRegular - totalDiscounted,
      pluginData,
    };
  }

  /* ─────────────────────────────────────────────────────────────────────────
   * ACTUALIZAR PANTALLA
   * ───────────────────────────────────────────────────────────────────────── */
  function updateDisplay() {
    const prices = calculatePrices();

    if (subPriceEl)     subPriceEl.textContent     = formatMoney(prices.subUnit);
    if (comparePriceEl) comparePriceEl.textContent = formatMoney(prices.refComparePrice);
    if (pricePerEl)     pricePerEl.textContent     = formatMoney(prices.subPerServing);
    if (onetimePriceEl) onetimePriceEl.textContent = formatMoney(prices.onetimeUnit);
    if (onetimePerEl)   onetimePerEl.textContent   = formatMoney(prices.onetimePerServing);
    if (savingsEl)      savingsEl.textContent      = formatMoney(prices.savings);
    if (totalCompareEl) totalCompareEl.textContent = formatMoney(prices.totalRegular);
    if (totalPriceEl)   totalPriceEl.textContent   = formatMoney(prices.totalDiscounted);

    const hasItems = prices.totalQty > 0;
    submitBtn.disabled = !hasItems || isProcessing;
    submitBtn.textContent = hasItems
      ? `{{ block.settings.button_text | default: "Add to Cart" }} — ${formatMoney(prices.totalDiscounted)}`
      : '{{ block.settings.button_text | default: "Add to Cart" }}';
  }

  /* ─────────────────────────────────────────────────────────────────────────
   * TAREA 1 – SINCRONIZAR EL INPUT .selected-selling-plan-id
   *
   * El plugin ShopifySubscriptionsWidget lee el valor de los inputs con clase
   * .selected-selling-plan-id que están DENTRO del formulario del tema.
   * Para que la suscripción quede registrada correctamente:
   *   1. Actualizamos nuestro input propio.
   *   2. Encontramos el/los forms del tema y les inyectamos/actualizamos
   *      un input con la misma clase si no existe.
   * ───────────────────────────────────────────────────────────────────────── */
  function syncSellingPlanInputs(planId) {
    const value = planId !== null ? String(planId) : '';

    // Actualizar nuestro input propio
    if (ownSellingPlanInput) {
      ownSellingPlanInput.value = value;
    }

    // Sincronizar en los forms del tema (los que tienen action /cart/add)
    // NOTA: esta función se mantiene disponible pero NO se llama en el flujo
    // normal para evitar que el plugin de suscripciones dispare su propio submit.
    // Solo llamarla manualmente si se necesita integración explícita con el form nativo.
    const themeForms = document.querySelectorAll('form[action*="/cart/add"]');
    themeForms.forEach(form => {
      let themeInput = form.querySelector('.selected-selling-plan-id');
      if (!themeInput) {
        themeInput = document.createElement('input');
        themeInput.type  = 'hidden';
        themeInput.name  = 'selling_plan';
        themeInput.classList.add('selected-selling-plan-id');
        form.appendChild(themeInput);
      }
      themeInput.value = value;
    });
    // ← NO disparamos 'change' aquí: ese evento triggerea listenToAddToCartForms()
    //   del plugin ShopifySubscriptionsWidget, causando un submit duplicado.
  }

  /* ─────────────────────────────────────────────────────────────────────────
   * ABRIR CART DRAWER (TAREA 4)
   *
   * Estrategia por capas:
   *   Capa 1 – Tema moderno: cart-drawer-component.open()
   *   Capa 2 – Fallback legacy: window.location.reload() con pequeño retraso
   * ───────────────────────────────────────────────────────────────────────── */
  function openCartDrawer() {
    // Capa 1: tema moderno (cart-drawer-component con método open())
    const cartDrawerEl = document.querySelector('cart-drawer-component');
    if (cartDrawerEl && typeof cartDrawerEl.open === 'function') {
      cartDrawerEl.open();
      return 'modern';
    }

    // Capa 2: tema legacy — recargar la página después de un breve retraso
    // para que el usuario vea el carrito actualizado con la suscripción
    console.warn('Pronto-Chocho v3: No se detectó cart-drawer moderno. Recargando página...');
    setTimeout(() => {
      window.location.reload();
    }, 800);
    return 'legacy-reload';
  }

  /* ─────────────────────────────────────────────────────────────────────────
   * NOTIFICACIÓN
   * ───────────────────────────────────────────────────────────────────────── */
  function showNotification(message, isError = false) {
    if (!notification) return;
    notification.textContent = message;
    notification.style.background = isError
      ? '#c0392b'
      : '{{ block.settings.notification_bg | default: "#4A6B1A" }}';
    notification.classList.add('show');
    setTimeout(() => notification.classList.remove('show'), isError ? 6000 : 3000);
  }

  /* ─────────────────────────────────────────────────────────────────────────
   * LISTENERS — Cambio de opción
   * ───────────────────────────────────────────────────────────────────────── */
  options.forEach(opt => {
    opt.addEventListener('click', function (e) {
      if (e.target.tagName === 'INPUT') return;

      currentOption = this.dataset.option;
      options.forEach(o => {
        const isActive = o === this;
        o.classList.toggle('active', isActive);
        const input = o.querySelector('input');
        if (input) input.checked = isActive;
      });

      updateDisplay();
    });
  });

  /* ─────────────────────────────────────────────────────────────────────────
   * LISTENERS — Cantidades
   * ───────────────────────────────────────────────────────────────────────── */
  products.forEach(product => {
    const variantId = product.dataset.variantId;
    const minusBtn  = product.querySelector('[data-qty="minus"]');
    const plusBtn   = product.querySelector('[data-qty="plus"]');
    const display   = product.querySelector('[data-quantity]');

    minusBtn?.addEventListener('click', () => {
      const current = quantities[variantId] || 0;
      if (current > 0) {
        quantities[variantId] = current - 1;
        display.textContent   = quantities[variantId];
        minusBtn.disabled     = quantities[variantId] === 0;
        updateDisplay();
      }
    });

    plusBtn?.addEventListener('click', () => {
      quantities[variantId] = (quantities[variantId] || 0) + 1;
      display.textContent   = quantities[variantId];
      if (minusBtn) minusBtn.disabled = false;
      updateDisplay();
    });
  });

  /* ─────────────────────────────────────────────────────────────────────────
   * OBTENER EL PLAN ID ACTIVO
   *
   * Prioridad: plugin (radio checkeado) → fallback manual del setting
   * ───────────────────────────────────────────────────────────────────────── */
  function getActivePlanId() {
    const pluginData = readPluginPlan();
    if (pluginData) {
      console.log(`Pronto-Chocho v3: Plan leído del plugin → ${pluginData.planId}`);
      return pluginData.planId;
    }
    if (fallbackPlanId) {
      console.log(`Pronto-Chocho v3: Plan manual (fallback) → ${fallbackPlanId}`);
      return fallbackPlanId;
    }
    console.warn('Pronto-Chocho v3: No se encontró un selling_plan_id válido.');
    return null;
  }

  /* ─────────────────────────────────────────────────────────────────────────
   * ADD TO CART → CHECKOUT DIRECTO
   * ───────────────────────────────────────────────────────────────────────── */
  submitBtn.addEventListener('click', async (e) => {
    // ── FIX DUPLICACIÓN 1 ─────────────────────────────────────────────────
    // Evitar que el evento burbujee hacia el form del tema o el plugin de
    // suscripciones, que tienen sus propios listeners y dispararían un
    // segundo request a /cart/add independiente del nuestro.
    e.preventDefault();
    e.stopImmediatePropagation();

    if (isProcessing) return;

    const isSubscription = currentOption === 'subscription';
    const planId         = isSubscription ? getActivePlanId() : null;

    if (isSubscription && planId === null) {
      console.warn(
        'Pronto-Chocho v3: currentOption="subscription" pero no se encontró ' +
        'selling_plan_id válido. Se añadirá como compra única.'
      );
    }

    // ── FIX DUPLICACIÓN 2 ─────────────────────────────────────────────────
    // Tomar una instantánea limpia de las cantidades actuales.
    // Iteramos products (NodeList, orden DOM) y construimos el array de una
    // sola pasada. Cada variante aparece exactamente UNA vez en items[].
    // No llamamos a syncSellingPlanInputs() aquí — eso inyectaba un
    // selling_plan en el form del tema y el plugin lo procesaba por separado.
    const items = [];
    products.forEach(p => {
      const variantId = p.dataset.variantId;
      const qty       = quantities[variantId] || 0;  // ← leer del estado, no del DOM
      if (qty <= 0) return;

      const item = {
        id      : parseInt(variantId, 10),
        quantity: qty,
      };

      // selling_plan solo si suscripción y plan válido — como número entero
      if (isSubscription && planId !== null) {
        item.selling_plan = planId;
        item.properties   = {
          _subscription : 'true',
          _purchase_type: 'subscription',
          _added_by     : 'pronto-chocho-v3',
        };
      }

      items.push(item);
    });

    if (items.length === 0) return;

    isProcessing       = true;
    submitBtn.disabled = true;
    submitBtn.classList.add('loading');

    try {
      console.log('Pronto-Chocho v3: Enviando items →', JSON.stringify(items, null, 2));

      const response = await fetch('/cart/add.js', {
        method : 'POST',
        headers: { 'Content-Type': 'application/json', Accept: 'application/json' },
        body   : JSON.stringify({ items }),
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        let errorMessage = errorData.description || errorData.message || 'Error al agregar al carrito';

        if (
          response.status === 422 &&
          (
            errorMessage.toLowerCase().includes('selling plan') ||
            errorMessage.toLowerCase().includes('subscription')
          )
        ) {
          errorMessage =
            `Plan de suscripción inválido (ID: ${planId ?? 'no configurado'}). ` +
            'Verifica el Selling Plan ID en la configuración del bloque.';
        }

        if (Array.isArray(errorData.items)) {
          errorData.items.forEach(itemErr => {
            if (itemErr.error) {
              console.error(`Pronto-Chocho v3 – Error variante ${itemErr.id}:`, itemErr.error);
            }
          });
        }

        throw new Error(errorMessage);
      }

      // ── ÉXITO: ir directo al checkout ─────────────────────────────────
      // No mostramos notificación ni abrimos drawer — la navegación es inmediata.
      console.log('Pronto-Chocho v3: Items agregados ✓ → redirigiendo a checkout');
      window.location.href = '/checkout';

      // (La ejecución se detiene aquí en la práctica por la redirección,
      //  pero reseteamos estado por si el navegador mantiene la página en caché)
      products.forEach(p => {
        quantities[p.dataset.variantId] = 0;
        const display  = p.querySelector('[data-quantity]');
        const minusBtn = p.querySelector('[data-qty="minus"]');
        if (display)  display.textContent = '0';
        if (minusBtn) minusBtn.disabled    = true;
      });

    } catch (err) {
      console.error('Pronto-Chocho v3 – Error:', err);
      showNotification(err.message || 'No se pudieron agregar los productos', true);
    } finally {
      isProcessing = false;
      submitBtn.classList.remove('loading');
      updateDisplay();
    }
  });

  /* ─────────────────────────────────────────────────────────────────────────
   * INIT
   * ───────────────────────────────────────────────────────────────────────── */
  // No llamamos syncSellingPlanInputs() al init: inyectar selling_plan en los
  // forms del tema en el arranque haría que el plugin procesara el plan de
  // forma independiente al hacer cualquier submit nativo del producto.
  updateDisplay();

  // Re-leer el plan si el plugin lo inicializa de forma asíncrona
  // (el widget puede renderizar los radios después del DOMContentLoaded)
  const pluginBootObserver = new MutationObserver(() => {
    const pluginData = readPluginPlan();
    if (pluginData) {
      console.log('Pronto-Chocho v3: Plugin detectado post-carga, actualizando precios.');
      updateDisplay();
      pluginBootObserver.disconnect();
    }
  });

  pluginBootObserver.observe(document.body, { childList: true, subtree: true });

  // Detener observer después de 10 segundos para no consumir recursos
  setTimeout(() => pluginBootObserver.disconnect(), 10000);

  console.log(
    `%cPronto-Chocho v3%c inicializado | Block: ${blockId} | ` +
    `Selling Plan (fallback): ${fallbackPlanId ?? 'NO CONFIGURADO'} | ` +
    `Plugin activo: ${readPluginPlan() ? '✓' : '✗ (esperando carga)'}`,
    'font-weight:bold;color:#4A6B1A',
    'color:inherit'
  );

})();
</script>

{% schema %}
{
  "name": "Pronto-Chocho Selector v3",
  "tag": null,
  "settings": [
    {
      "type": "header",
      "content": "Subscription Option"
    },
    {
      "type": "text",
      "id": "sub_title",
      "label": "Title",
      "default": "Subscribe & Save"
    },
    {
      "type": "text",
      "id": "sub_subtitle",
      "label": "Subtitle",
      "default": "15 servings per bag"
    },
    {
      "type": "range",
      "id": "subscription_discount",
      "label": "Discount % (fallback si el plugin no está activo)",
      "min": 5,
      "max": 50,
      "step": 5,
      "unit": "%",
      "default": 15
    },
    {
      "type": "checkbox",
      "id": "show_benefits",
      "label": "Show benefits",
      "default": true
    },
    {
      "type": "text",
      "id": "benefit_1",
      "label": "Benefit 1",
      "default": "Save money on every order"
    },
    {
      "type": "text",
      "id": "benefit_2",
      "label": "Benefit 2",
      "default": "Easily change your quantities"
    },
    {
      "type": "text",
      "id": "benefit_3",
      "label": "Benefit 3",
      "default": "Cancel any time"
    },
    {
      "type": "text",
      "id": "benefit_4",
      "label": "Benefit 4",
      "default": "Pre-shipment reminders"
    },
    {
      "type": "header",
      "content": "One-time Option"
    },
    {
      "type": "text",
      "id": "onetime_title",
      "label": "Title",
      "default": "One-time purchase"
    },
    {
      "type": "text",
      "id": "onetime_subtitle",
      "label": "Subtitle",
      "default": "15 servings per bag"
    },
    {
      "type": "header",
      "content": "Products"
    },
    {
      "type": "text",
      "id": "flavors_label",
      "label": "Flavors label",
      "default": "Choose your flavors"
    },
    {
      "type": "product",
      "id": "product_1",
      "label": "Product 1"
    },
    {
      "type": "product",
      "id": "product_2",
      "label": "Product 2"
    },
    {
      "type": "product",
      "id": "product_3",
      "label": "Product 3"
    },
    {
      "type": "product",
      "id": "product_4",
      "label": "Product 4"
    },
    {
      "type": "product",
      "id": "product_5",
      "label": "Product 5"
    },
    {
      "type": "text",
      "id": "servings_text",
      "label": "Servings text",
      "default": "15 servings"
    },
    {
      "type": "text",
      "id": "per_text",
      "label": "Per unit text",
      "default": "serving"
    },
    {
      "type": "number",
      "id": "servings_per_unit",
      "label": "Servings per unit",
      "default": 15
    },
    {
      "type": "header",
      "content": "Selling Plan (fallback)"
    },
    {
      "type": "text",
      "id": "selling_plan_id",
      "label": "Selling Plan ID",
      "info": "ID numérico del plan. Solo se usa si el plugin no está activo. Ejemplo: 3233841344"
    },
    {
      "type": "header",
      "content": "Savings Bar"
    },
    {
      "type": "text",
      "id": "savings_label",
      "label": "Savings label",
      "default": "You're saving"
    },
    {
      "type": "header",
      "content": "Button"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text",
      "default": "Add to Cart"
    },
    {
      "type": "header",
      "content": "Notification"
    },
    {
      "type": "text",
      "id": "notification_text",
      "label": "Notification text",
      "default": "¡Productos agregados al carrito!"
    },
    {
      "type": "color",
      "id": "notification_bg",
      "label": "Notification background",
      "default": "#4A6B1A"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "badge_bg",
      "label": "Badge background",
      "default": "#4A6B1A"
    },
    {
      "type": "color",
      "id": "badge_text",
      "label": "Badge text",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "active_border",
      "label": "Active border",
      "default": "#4A6B1A"
    },
    {
      "type": "color",
      "id": "active_bg",
      "label": "Active background",
      "default": "#FCF3EC"
    },
    {
      "type": "color",
      "id": "price_color",
      "label": "Price color",
      "default": "#4A6B1A"
    },
    {
      "type": "color",
      "id": "button_bg",
      "label": "Button background",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button text",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "button_hover",
      "label": "Button hover",
      "default": "#333333"
    }
  ],
  "presets": [
    {
      "name": "Pronto-Chocho Selector v3"
    }
  ]
}
{% endschema %}
